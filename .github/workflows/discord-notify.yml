name: Discord Notification on Merge

on:
  pull_request_target:
    types: [closed]

jobs:
  notify:
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPOSITORY_NAME: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_USER: ${{ github.event.pull_request.user.login }}
        run: |
          curl -X POST -H "Content-Type: application/json" \
          -d "{
                \"content\": null,
                \"embeds\": [
                  {
          REPOSITORY_NAME_JSON=$(jq -Rn --arg v "$REPOSITORY_NAME" '$v')
          curl -X POST -H "Content-Type: application/json" \
          -d "{
                \"content\": null,
                \"embeds\": [
                  {
                    \"title\": ${REPOSITORY_NAME_JSON},
                    \"description\": \"${PR_USER} „ÅÆ‰ΩúÊàê„Åó„Åü Pull Request „Åå ${{ github.event.pull_request.base.ref }} „Å´„Éû„Éº„Ç∏„Åï„Çå„Åæ„Åó„Åü üéâ \n ${PR_TITLE}\",
                    \"color\": 5814783,
                    \"url\": \"${PR_URL}\",
                    \"author\": {
                      \"name\": \"${{ github.repository_owner }}\",
                      \"url\": \"https://github.com/${{ github.repository_owner }}\",
                      \"icon_url\": \"https://github.com/${{ github.repository_owner }}.png\"
                    }
                  }
                ],
                \"username\": \"GitHub CI/CD Bot\",
                \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\"
              }" \
          jq -n \
            --arg repo_name "$REPOSITORY_NAME" \
            --arg pr_user "$PR_USER" \
            --arg pr_title "$PR_TITLE" \
            --arg pr_url "$PR_URL" \
            --arg base_ref "${{ github.event.pull_request.base.ref }}" \
            --arg author_name "${{ github.repository_owner }}" \
            '{
              content: null,
              embeds: [
                {
                  title: $repo_name,
                  description: ($pr_user + " „ÅÆ‰ΩúÊàê„Åó„Åü Pull Request „Åå " + $base_ref + " „Å´„Éû„Éº„Ç∏„Åï„Çå„Åæ„Åó„Åü üéâ \n " + $pr_title),
                  color: 5814783,
                  url: $pr_url,
                  author: {
                    name: $author_name,
                    url: ("https://github.com/" + $author_name),
                    icon_url: ("https://github.com/" + $author_name + ".png")
                  }
                }
              ],
              username: "GitHub CI/CD Bot",
              avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
            }' \
          | curl -X POST -H "Content-Type: application/json" -d @- $DISCORD_WEBHOOK_URL
